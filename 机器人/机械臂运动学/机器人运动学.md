### 旋转矩阵的三大用处

1. 计算某个点在不同坐标系下的位置

2. 一个坐标系相对另一个坐标系的姿态

3. 计算在一个坐标系下旋转一个向量后得到的新向量

![image-20200219155733783](..\..\picture\image-20200219155733783.png)
$$
^Ap=^AR_B \cdot ^Bp\\
a_1\cdot b_1 = R_{11}b_1 \cdot b_1+R_{12}b_2 \cdot b_1+R_{13}b_3 \cdot b_1=R_{11}\\
\left[ ^AR_B \right]_{ij}=a_i \cdot b_j\\
^Ap=^Ap_1a_1+^Ap_2a_2+^Ap_3a_3\\
^Bp=^Bp_1a_1+^Bp_2a_2+^Bp_3a_3\\
^Bp={^BR_A}^Ap\\
^BR_A=^AR_B^T
$$
![image-20200219162516521](..\..\picture\image-20200219162516521.png)
$$
坐标系\color{blue}{B}\color{black}{相对坐标系}\color{yellow}{A}
$$

$$
^AR_B=\begin{bmatrix} 1 &0 &0 \\0 &cos{\theta} &-sin\theta\\0 &sin\theta &cos\theta \end{bmatrix}\\
R_{x,\theta}\\
绕x轴的旋转\theta
$$
![image-20200219170102256](..\..\picture\image-20200219170102256.png)
$$
R_{y,\theta}=\begin{bmatrix} cos\theta &0 &sin\theta\\0 &1 &0\\-sin\theta &0 &cos\theta \end{bmatrix}\\
R_{z,\theta}=\begin{bmatrix} cos\theta &-sin\theta &0\\
sin\theta &cos\theta &0\\0 &0&1\end{bmatrix}
$$
![image-20200219170126638](..\..\picture\image-20200219170126638.png)

1. 任意两个旋转矩阵的乘积仍然是一个 旋转矩阵
2. 任意一个旋转矩阵的逆仍然是一个旋转矩阵
3. 所有旋转矩阵组成一个群

​          ![image-20200229173506146](..\..\picture\image-20200229173506146.png)

* 运动链——两个以上的连杆通过关节联接而成的系统成为运动链
    * 闭式运动链
    * 开式运动链 
* 构型空间
    * 机器人的构型是一个 机器人所有点的位置。
    * 机器人的所有可能构型称为机器人的 构型空间。
* 机器人的<font size=6 face="楷体" >**自由度**</font>是描述机器人构型的最小实数坐标的个数。
* 机器人的<font face="楷体" size=5>**工作空间**</font>是指机器嗯末端执行器运动描述参考点所能达到的空间点的集合
* D-H参数

    * 描述任意运动链
    * 每个连杆上固定一个坐标系
    * 定义四个参数


​       DH参数就是一个用四个参数表达两对关节连杆之间位置角度关系的机械臂数学模型和坐标系确定系统。通过限制原点位置和x轴的方向，人为减少了两个自由度，因此 他只需要用四个参数即可表达关节之间原本是六自由度的坐标变换。



* **DH四个参数的物理意义**
    * 连杆长度：两个关节的轴（旋转关节的旋转轴，平移关节的平移轴 ）之间的公共法线长度
    * 连杆扭转：一个关节的轴相对于另一个关节的轴绕他们的公共法线的角度。
    * 连杆偏转：一个关节与下一个关节的公共法线和它与上一个关节的公共发现沿这个关节轴的距离。
    * 关节转角：一个关节与下一个关节的公共法线和它与上一个关节的公共法线绕这个关节轴的转角。


*  **DH参数惯例 **

	* 确定原点。原点为本关节与下一关节公共法线和本关节轴的交点，如果是最后一个关节，则为前一个关节与本关节公共法线与本关节轴的交点。

		![ ](..\..\picture\image-20200305180813560.png)

		上图中第二个关节和第三个关节的轴相交了，所以他们的公共法线显然就在轴的交点上。

	* Z轴从原点出发，与关节轴重合。但在地面坐标系和末端执行坐标系已知的情况下，我们会通常希望当前的Z轴与上一个已经确定的z轴是0°或者180°，最后一个关节的z轴若是能与末端执行器的z轴重合则选择让他们重合。

	* x轴为本关节轴指向下一关节轴的公共法线，与两个关节的轴都垂直。但当两条z轴相交时我们无法确定x轴的方向，这个时候我们可以选择**x轴的方向使当前z轴与下一个z轴的夹角（即当前关节与下一个关节的link twist）为正且小于180°。而当两条z轴平行或者重合时，x轴的选择就比较随意了，我们通常会尽量让他们与前或后一致。对于最后一个关节，我们也经常选择与末端执行器更接近的坐标。             

		![image-20200305181748428](..\..\picture\image-20200305181748428.png)

	* 确定好两个轴的坐标后，可以根据右手定则确定y轴。

# crigDH坐标系规则

## 对于连杆的规定

​        从操作臂的固定基座开始为连杆进行编号，可以称固定基座为连杆0.第一个可动连杆为连杆1.操作臂最末端的连杆为连杆n。为了确定末端执行器再3维空间的位置和姿态，操作臂至少需要6个关节。

​		连杆的长度$a_i$和转角$\alpha_{i}$取决于关节轴线 $i$和$i+1$.

## 对于连杆附加坐标系的规定

​		通常按照下面的办法确定连杆上的固定坐标系：	确定连杆上的固连坐标系：坐标系{$i$}的$Z$轴称为$Z_i$,并与关节轴$i$重合，坐标系{$i$}的原点位于公垂线$a_i$与关节轴$i$的交点处。$X_i$沿$a_i$方向由关节$i$指向关节$i+1$.

​		当$a_i=0$时，$X_i$垂直于$Z_i$和$Z_i+1$所在的平面，按右手定则绕$X_i$轴的转角定义为$\alpha_i$,由于$X_i$轴 的方向可以有两种选择，因此$\alpha_i$的符号也有两种选择。$Y_i$轴由右手定则确定，从而完成了对坐标系{$i$}的定义，

* 机械臂运动学示意图
    * 通常画机械臂零构型
    * 用线段表示连杆
    * 用三维关节图表示关节
    * 标出每个关节的轴（旋转关节为旋转所绕轴，平移关节为平移所沿轴），按照惯例取z轴。
    * 标出每个关节变量（通常 旋转关节变量用$\theta$,平移关节变量用$d$.
    * 标出每个关节变量的正方向，用箭头表示。
    * 给旋转关节和轴编号，从底座标到端号，轴的下标从0开始，关节变量下标从1开始。

![image-20200301091651617](..\..\picture\image-20200301091651617.png)

​	

* 对于一个新机构，可以按照下面的步骤正确建立连杆坐标系
    * 找出各关节轴，并标出和画出这些轴的延长线，在下面的步骤2至步骤5中，仅考虑两个相邻的轴线（关节轴的$i和i+1$）.
    * 找出关节轴$i和i+1$之间的公垂线或关节轴$i和i+1$的交点，以关节轴$i和i+1$的交点或公垂线与关节轴$i$的交点作为连杆坐标系{$i$}的原点。
    * 规定$Z_i$轴沿关节轴$i$的指向。
    * 规定$X_i$轴沿公垂线的指向，如果关节轴$i和i+1$相交，则规定$X_i$轴垂直于关节周$i和i+1$所在的平面。
    * 按照右手定则确定$Y_i$轴。
    * 当第一个关节变量为0时，规定坐标系{$0$}和{$1$}重合。对于坐标系{N}，其原点和$X_N$的方向可以任意选取。但是在选取时，通常尽量使两岸参数为0.



![image-20200303120440140](..\..\picture\image-20200303120440140.png)

![image-20200301232427688](..\..\picture\image-20200301232427688.png)

![image-20200402215154579](..\..\picture\image-20200402215154579.png)

![image-20200402215245451](..\..\picture\image-20200402215245451.png)



## 标准DH参数规则

![image-20200303162405872](..\..\picture\image-20200303162405872.png)

![image-20200402215319652](..\..\picture\image-20200402215319652.png)

![image-20200402215352094](..\..\picture\image-20200402215352094.png)

#### 关节&连杆

	* 关节i连接连杆i-1和连杆i。
	* 关节i被驱动时，连杆i发生转动。

#### 关节&坐标系：

​		$Z_i$是第i+1个关节的驱动轴。

​		以上约束条件保证了关节i被驱动时，连杆i以及项链坐标系$O_i$都将经历一个相应的运动。

#### 建立坐标系

​		**DH法的约束条件：**

​		后一个关节坐标系$O_{i+1}$的x轴要 **垂直并且相交**于前一个坐标系$Q_i$的z轴。

​		$Z_i$轴作为第i+1个关节的驱动轴，其方向和关节轴线方向保持一致。

	* 轴$Z_{i-1}$和轴$Z_i$不共面

那么轴$Z_{i-1}$和轴$Z_i$的公垂线定义了x轴，并且它与轴Zi的交点即为原点Oi。

	* 轴$Z_{i-1}$和轴$Z_i$平行

这种情况下，轴$Z_{i-1}$和轴$Z_i$之间存在无穷多个共同法线。将穿过原点Oi-1的法线选做xi轴，Oi是该法线和Zi轴的交点。

	* 轴$Z_{i-1}$和轴$Z_i$相交

选择xi轴垂直于由Zi-1和Zi组成的平面。原点Oi一般设为Zi-1和Zi的交点。不过，轴线Zi上的任意一点都可以被选座位原点。

### “使DH参数简单的”的一些法则

* 确定xi轴的方向时，如果有很多种选择，尽可能选择于Xi-1相同的方向。
* 确定坐标系0时，使得关节变量的取值为零。

####  example

![image-20200317225823995](..\..\picture\image-20200317225823995.png)

![image-20200317225845619](..\..\picture\image-20200317225845619.png)

## 连杆变换的推导

​		对于任意给定的机器人，这个变换是只有一个变量的函数，另外三个参数是由机械系统确定的。

![image-20200302151425523](..\..\picture\image-20200302151425523.png)

![image-20200302151445147](..\..\picture\image-20200302151445147.png)

## 操作臂逆运动学

​		**运动学逆问题：已知工具坐标系相对于工作台坐标系的期望位置和姿态，如何计算一系列满足期望要求的关节角？**

​		为求出要求的环节叫以防止相对于工作台坐标系{$S$}的工具坐标系{$T$}，可将这个问题分为两部分：首先，进行坐标变换求出相对于极坐标系{$B$}的腕部坐标系{$W$},完后逆运动学求关节角。

​		解是否存在的问题完全取决于操作臂的工作空间。**工作空间**是操作比末端执行器所能达到的范围。工作空间可以有两种定义：**灵巧工作空间**指机器人的末端执行器能够从各个方向到达的空间区域。也就是说，机器人末端执行器可以从任意方向到达灵巧工作空间的每一个点。**可达工作空间**是机器人至少从一个方向上有一个方位可以达到的空间。灵巧工作空间是可达工作空间的子集。

​		工作空间取决于工具坐标系的变换，我们平时所讨论的工具端点一般就是我们所说的可达空间点。

​		确定n自由度操作臂子空间的一种方法就是给出腕部坐标系或者工具坐标系的表达式，他是含有n个变量的函数。如果把这n个变量看作自由变量，那么他们所有的可能取值就构成了这个子空间。

解的存在性主要与机构工作空间有关。

解存在即意味着末端执行器的 目标点位于工作空间中。

非线性超越方程组一般存在多解。

存在多组不同的关节变量使末端执行器处于相同的位姿，或者说末端执行器位姿到关节变量的映射不是唯一的。

解的数量与关节数量和结构参数有关，一般地，关节变量多，非零结构参数多，则逆解个数也会增多。

在对机构进行控制时，必须选择一个解来控制末端执行器从当前位姿到目标位姿。

对于给定的目标位姿，如果使用某种算法能够确定关节变量所有解集，那摩称机构是可解的。

仅由转动副和移动副连接的6DOF单开链机构是可解的。

**解析解或封闭形式解、数值解法。**

### 逆运动学pieper解法

​		6轴机械臂具有三个连续的轴交在同一点，则手臂有解析解。

​		一般会把六轴如此设计：前三轴产生移动。后三轴产生转动。

六个旋转轴的机械臂，因后三轴交在一点，可得$^0P_{6 ORG}=^0P_{4ORG}$



## 解析解或封闭形式解

关节变量可显式地表示成目标位姿的函数。

自由度不大于4的串联机构逆解能表达成封闭形式，自由度为6的串联机构一般不具有解析解。

当机构具有特殊的几何关系，如机构本身是解耦结构时，才有封闭解存在。

## 绕任意向量旋转

​		对于空间中两个任意姿态的坐标系，总可以在空间中找到某个轴，是其中一个坐标系绕该轴旋转一个角度就能与另一个坐标系姿态重合。

​		为了找到绕着旋转的轴，那就是我们要旋转的轴必须与旋转保持一致。任何在旋转轴上的点都是旋转的。这意味着旋转轴必须是矩阵r的特征向量，旋转矩阵有三个特征向量。而正交矩阵总有一个实特征值1，此时$Rv=\lambda v$ 化简为$Rv=v$,这意味着此时特征向量v不随旋转发生改变，而旋转是以这个向量为轴发生的。

​		反过来，使用罗德里格斯旋转方程，我们可以从角度和向量计算出相应的旋转矩阵：
$$
R=I_{3*3}+sin\theta S(v)+(1-cos\theta)(vv^T-I_{3*3})
$$
运用工具箱函数$angvec2r$可以计算相关的旋转矩阵：

## 时变旋转矩阵微分表达式

$$
\begin{align}
\dot R\langle t\rangle&=S(\omega)R\langle t\rangle\\
\dot R&\in SO(2)or SO(3)
\end{align}
$$

$S(\cdot)$是一个斜对称矩阵。$\omega$是角速度，
$$
S(\omega)=\begin{pmatrix}
0 &-\omega_z &\omega_y\\
\omega_z &0 &-\omega_x\\
-\omega_y &\omega_x &0
\end{pmatrix}
$$


#### 代码skew、vex

![image-20200317161540207](..\..\picture\image-20200317161540207.png)

![image-20200317161557623](..\..\picture\image-20200317161557623.png)

#### 微分近似法

$$
\dot R\approx\frac{R(t+\delta_t) -R(t)}{\delta_t}\\
R(t+\delta t)\approx \delta_t \dot R+R(t)\\
R(t+\delta_t)\approx \delta_tS(\omega)R(t)+R(t)\approx(\delta_tS(\omega)+I_{3*3})R(t)
$$

标准正交旋转矩阵可以看作是一个以角速度为自变量的函数。

#### 增量运动

现在考虑一个坐标系经过一个微笑转动从R0变道R1.
$$
R_1=(\delta_tS(\omega)+I_{3*3})R_0\\
\delta_tS(\omega)=R_1R_0^T-I_{3*3}\\
\delta_\theta=vex(R_1R_0^T-I_{3*3})
$$
$\theta$是角度，表示绕一个世界坐标系的xyz三轴的无穷小转动。

在旋转矩阵中，无穷小角度变化的乘法是可以交换的。

两个差异极小的位姿，可以用一个六维小姑凉来表示他们之间的差异。
$$
\delta=\Delta(\zeta_0,\zeta_1)=(\delta_d,\delta_\theta)
$$
$\delta$由空间速度诚意无穷小的时间间隔得到。

#### 代码-delta2tr、tr2delta

